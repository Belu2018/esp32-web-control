https://unpkg.com/mqtt/dist/mqtt.min.js</script>
<script>
  const t26Set   = "home/esp32/gpio26/set";
  const t27Set   = "home/esp32/gpio27/set";
  const t26State = "home/esp32/gpio26/state";
  const t27State = "home/esp32/gpio27/state";

  let client = null;
  let s26 = "OFF", s27 = "OFF";

  const logEl = document.getElementById("log");
  const wsurlEl = document.getElementById("wsurl");
  const errEl = document.getElementById("lasterr");

  function log(msg) {
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
    console.log(msg);
  }

  function getUrl() {
    const host = document.getElementById("host").value.trim();
    const port = document.getElementById("port").value.trim() || "8884";
    return `wss://${host}:${port}/mqtt`; // correct for HiveMQ Cloud [1](https://randomnerdtutorials.com/esp32-https-requests/)[2](https://microcontrollerslab.com/esp32-https-requests/)
  }

  // ðŸ”Ž 1) Raw WebSocket test (no MQTT yet)
  function testWebSocket() {
    const url = getUrl();
    wsurlEl.textContent = url;
    errEl.textContent = "-";
    log("WS TEST: opening " + url);

    // HiveMQ Cloud expects /mqtt and secure websocket on 8884 [1](https://randomnerdtutorials.com/esp32-https-requests/)[2](https://microcontrollerslab.com/esp32-https-requests/)
    const ws = new WebSocket(url, "mqtt");

    const timer = setTimeout(() => {
      log("WS TEST: âŒ timeout (likely blocked by network/firewall)");
      errEl.textContent = "WebSocket timeout (network may block port 8884)";
      try { ws.close(); } catch(e) {}
    }, 15000);

    ws.onopen = () => { clearTimeout(timer); log("WS TEST: âœ… open (port reachable)"); ws.close(); };
    ws.onerror = () => { clearTimeout(timer); log("WS TEST: âŒ error (blocked or DNS issue)"); errEl.textContent = "WebSocket error"; };
    ws.onclose = (e) => { clearTimeout(timer); log(`WS TEST: closed (code=${e.code})`); };
  }

  // ðŸ”Œ 2) MQTT connect (after WS is confirmed)
  function connectMqtt() {
    const host = document.getElementById("host").value.trim();
    const user = document.getElementById("user").value.trim();
    const pass = document.getElementById("pass").value;

    const url = getUrl();
    wsurlEl.textContent = url;
    errEl.textContent = "-";

    if (!host || !user || !pass) {
      errEl.textContent = "Missing host/user/pass";
      return;
    }

    if (client) { try { client.end(true); } catch(e) {} client = null; }

    const clientId = "web-" + Math.random().toString(16).slice(2);
    log("MQTT: Connecting to " + url);

    // Watchdog in case connect never resolves
    let watchdog = setTimeout(() => {
      log("MQTT: âŒ still not connected after 15s (likely blocked port 8884)");
      errEl.textContent = "MQTT connect timeout (network may block port 8884)";
      try { client?.end(true); } catch(e) {}
    }, 15000);

    client = mqtt.connect(url, {
      clientId,
      username: user,
      password: pass,
      clean: true,
      reconnectPeriod: 2000
    });

    client.on("connect", () => {
      clearTimeout(watchdog);
      log("MQTT: âœ… Connected!");
      client.subscribe([t26State, t27State]);
    });

    client.on("error", (e) => {
      clearTimeout(watchdog);
      log("MQTT: âŒ Error: " + (e?.message || e));
      errEl.textContent = e?.message || String(e);
    });

    client.on("close", () => {
      log("MQTT: connection closed");
    });

    client.on("message", (topic, payload) => {
      const msg = payload.toString().trim().toUpperCase();
      log(`${topic} => ${msg}`);
    });
  }

  // Hook your buttons (add two buttons in HTML with these ids)
  document.getElementById("wsTestBtn").addEventListener("click", testWebSocket);
  document.getElementById("connectBtn").addEventListener("click", connectMqtt);
  
<button id="wsTestBtn">WebSocket Test</button>
<button id="connectBtn">Connect</button>

</script>

