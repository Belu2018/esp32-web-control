<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 Web Control (HiveMQ Cloud)</title>
  <style>
    :root { --bg:#0b1220; --card:#121b2f; --muted:#9fb0d0; --text:#e7eeff; --accent:#58a6ff; --good:#36d399; --bad:#ff6b6b; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 14px; }
    label { display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.14); background: rgba(0,0,0,0.25); color: var(--text); outline: none; }
    input:focus { border-color: rgba(88,166,255,0.7); box-shadow: 0 0 0 3px rgba(88,166,255,0.15); }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    button { cursor:pointer; padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.16); background: rgba(88,166,255,0.15); color: var(--text); font-weight: 600; }
    button:hover { background: rgba(88,166,255,0.25); }
    button.secondary { background: rgba(255,255,255,0.06); }
    button.secondary:hover { background: rgba(255,255,255,0.10); }
    button.toggle { min-width: 110px; justify-content: center; display:inline-flex; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; font-size: 12px; border: 1px solid rgba(255,255,255,0.14); }
    .pill.good { color: var(--good); border-color: rgba(54,211,153,0.35); background: rgba(54,211,153,0.08); }
    .pill.bad { color: var(--bad); border-color: rgba(255,107,107,0.35); background: rgba(255,107,107,0.08); }
    .pill.muted { color: var(--muted); }
    pre { margin: 0; padding: 12px; background: rgba(0,0,0,0.35); border-radius: 12px; overflow:auto; max-height: 260px; border: 1px solid rgba(255,255,255,0.08); }
    .hint { color: var(--muted); font-size: 12px; line-height: 1.4; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>

  <!-- MQTT.js via CDN (unpkg). If you want faster load, host it locally. -->
  <script src="https://unpkg.com/mqtt/dist/mcript>
</head>

<body>
  <div class="wrap">
    <h1>ESP32 Web Control (HiveMQ Cloud)</h1>

    <div class="grid">
      <!-- CONNECT CARD -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div class="pill muted" id="statusPill">DISCONNECTED</div>
          </div>
          <div class="row">
            <button id="btnConnect">Connect</button>
            <button id="btnDisconnect" class="secondary" disabled>Disconnect</button>
          </div>
        </div>

        <label>WSS URL (HiveMQ Cloud WebSocket + TLS listener)</label>
        <input id="wssUrl" class="mono"
               value="wss://267c603ceea5484c9b7c4b1e3777e721.s1.eu.hivemq.cloud:8884/mqtt" />

        <div class="row">
          <div style="flex:1; min-width: 220px;">
            <label>Username (MQTT Credentials)</label>
            <input id="username" value="" />
          </div>
          <div style="flex:1; min-width: 220px;">
            <label>Password</label>
            <input id="password" type="password" value="" />
          </div>
        </div>

        <div class="hint" style="margin-top:10px;">
          Tip: This page sets a fast <span class="mono">connectTimeout</span> (4s) so it won’t sit on “Connecting…” for 30s. [1](https://deepwiki.com/mqttjs/MQTT.js/2-client-api)[2](https://www.npmjs.com/package/mqtt)
          <br/>
          For browsers, HiveMQ Cloud uses port <span class="mono">8884</span> with <span class="mono">wss://.../mqtt</span>. [3](https://community.hivemq.com/t/mqtt-server-not-connecting-on-port-8884/1492)[4](https://stackoverflow.com/questions/75851672/i-cant-connect-mqtt-hivemq)
        </div>
      </div>

      <!-- GPIO CARD -->
      <div class="card">
        <h2 style="margin:0 0 12px; font-size:16px;">GPIO Controls</h2>

        <div class="row" style="justify-content:space-between; margin-bottom: 10px;">
          <div>
            <div style="font-weight:700;">GPIO 26</div>
            <div class="hint mono" id="gpio26State">state: (unknown)</div>
          </div>
          <button class="toggle" id="gpio26Btn" disabled>OFF</button>
        </div>

        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-weight:700;">GPIO 27</div>
            <div class="hint mono" id="gpio27State">state: (unknown)</div>
          </div>
          <button class="toggle" id="gpio27Btn" disabled>OFF</button>
        </div>

        <div class="hint" style="margin-top: 12px;">
          Topics used:
          <div class="mono" style="margin-top:6px;">
            home/esp32/gpio26/set &nbsp;|&nbsp; home/esp32/gpio26/state<br/>
            home/esp32/gpio27/set &nbsp;|&nbsp; home/esp32/gpio27/state
          </div>
        </div>
      </div>

      <!-- DEBUG LOG -->
      <div class="card" style="grid-column: 1 / -1;">
        <div class="row" style="justify-content:space-between;">
          <h2 style="margin:0; font-size:16px;">Debug log</h2>
          <button class="secondary" id="btnClear">Clear</button>
        </div>
        <pre id="log" class="mono"></pre>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===================== Topics =====================
  const TOPIC_26_SET   = "home/esp32/gpio26/set";
  const TOPIC_27_SET   = "home/esp32/gpio27/set";
  const TOPIC_26_STATE = "home/esp32/gpio26/state";
  const TOPIC_27_STATE = "home/esp32/gpio27/state";

  // ===================== UI refs =====================
  const el = (id) => document.getElementById(id);
  const logEl = el("log");
  const statusPill = el("statusPill");

  const btnConnect = el("btnConnect");
  const btnDisconnect = el("btnDisconnect");
  const btnClear = el("btnClear");

  const wssUrlInput = el("wssUrl");
  const usernameInput = el("username");
  const passwordInput = el("password");

  const gpio26Btn = el("gpio26Btn");
  const gpio27Btn = el("gpio27Btn");
  const gpio26State = el("gpio26State");
  const gpio27State = el("gpio27State");

  // ===================== State =====================
  let client = null;
  let state26 = null; // true/false/null
  let state27 = null;

  function addLog(msg) {
    const ts = new Date().toLocaleTimeString();
    logEl.textContent += `[${ts}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setStatus(text, kind) {
    statusPill.textContent = text;
    statusPill.className = "pill " + (kind || "muted");
  }

  function normalizeState(payload) {
    const s = (payload || "").toString().trim().toUpperCase();
    return (s === "ON" || s === "1" || s === "TRUE");
  }

  function render() {
    // GPIO 26
    gpio26Btn.disabled = !client || !client.connected;
    if (state26 === null) {
      gpio26Btn.textContent = "OFF";
      gpio26Btn.style.opacity = 0.85;
      gpio26State.textContent = "state: (unknown)";
    } else {
      gpio26Btn.textContent = state26 ? "ON" : "OFF";
      gpio26Btn.style.opacity = 1;
      gpio26State.textContent = `state: ${state26 ? "ON" : "OFF"}`;
    }

    // GPIO 27
    gpio27Btn.disabled = !client || !client.connected;
    if (state27 === null) {
      gpio27Btn.textContent = "OFF";
      gpio27Btn.style.opacity = 0.85;
      gpio27State.textContent = "state: (unknown)";
    } else {
      gpio27Btn.textContent = state27 ? "ON" : "OFF";
      gpio27Btn.style.opacity = 1;
      gpio27State.textContent = `state: ${state27 ? "ON" : "OFF"}`;
    }

    // Connect/disconnect buttons
    btnConnect.disabled = client && client.connected;
    btnDisconnect.disabled = !(client && client.connected);
  }

  function safeEndClient() {
    if (!client) return;
    try {
      client.end(true); // force close
    } catch {}
    client = null;
    setStatus("DISCONNECTED", "bad");
    addLog("Disconnected");
    render();
  }

  // ===================== MQTT Connect =====================
  function connect() {
    const url = wssUrlInput.value.trim();
    const username = usernameInput.value.trim();
    const password = passwordInput.value;

    if (!url.startsWith("wss://")) {
      addLog("⚠️ URL must start with wss:// (secure websockets).");
      return;
    }

    // If there is an existing client, close it first.
    safeEndClient();

    setStatus("CONNECTING…", "muted");
    addLog(`Connecting to: ${url}`);

    const t0 = performance.now();

    // MQTT.js options:
    // - connectTimeout default is 30000ms; we set 4000ms to fail fast. [1](https://deepwiki.com/mqttjs/MQTT.js/2-client-api)[2](https://www.npmjs.com/package/mqtt)
    // - reconnectPeriod default is 1000ms; we set 2000ms. [1](https://deepwiki.com/mqttjs/MQTT.js/2-client-api)[2](https://www.npmjs.com/package/mqtt)
    const options = {
      username,
      password,
      keepalive: 60,
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 2000,
      // clientId can be set explicitly if you want:
      // clientId: "web-" + Math.random().toString(16).slice(2),
    };

    client = mqtt.connect(url, options);

    client.on("connect", () => {
      const ms = Math.round(performance.now() - t0);
      setStatus("CONNECTED", "good");
      addLog(`✅ Connected in ${ms} ms`);

      // Subscribe to state topics (retained messages from ESP32 will update UI quickly)
      client.subscribe([TOPIC_26_STATE, TOPIC_27_STATE], (err) => {
        if (err) addLog("❌ Subscribe error: " + err.message);
        else addLog("Subscribed to state topics.");
      });

      render();
    });

    client.on("message", (topic, payload) => {
      const msg = payload.toString();
      addLog(`Message: ${topic} => ${msg}`);

      if (topic === TOPIC_26_STATE) {
        state26 = normalizeState(msg);
        render();
      }
      if (topic === TOPIC_27_STATE) {
        state27 = normalizeState(msg);
        render();
      }
    });

    client.on("reconnect", () => {
      setStatus("RECONNECTING…", "muted");
      addLog("Reconnecting…");
      render();
    });

    client.on("close", () => {
      setStatus("DISCONNECTED", "bad");
      addLog("Connection closed.");
      render();
    });

    client.on("error", (err) => {
      setStatus("ERROR", "bad");
      addLog("❌ Error: " + (err?.message || err));
      // Do not call end() here; mqtt.js will handle reconnect unless reconnectPeriod=0.
      render();
    });

    render();
  }

  // ===================== Publish helpers =====================
  function publish(topic, payload) {
    if (!client || !client.connected) {
      addLog("⚠️ Not connected. Cannot publish.");
      return;
    }

    client.publish(topic, payload, { qos: 0, retain: false }, (err) => {
      if (err) addLog("❌ Publish error: " + err.message);
      else addLog(`Published: ${topic} <= ${payload}`);
    });
  }

  // ===================== UI events =====================
  btnConnect.addEventListener("click", connect);
  btnDisconnect.addEventListener("click", safeEndClient);
  btnClear.addEventListener("click", () => logEl.textContent = "");

  gpio26Btn.addEventListener("click", () => {
    const next = !(state26 === true);
    publish(TOPIC_26_SET, next ? "ON" : "OFF");
  });

  gpio27Btn.addEventListener("click", () => {
    const next = !(state27 === true);
    publish(TOPIC_27_SET, next ? "ON" : "OFF");
  });

  // Initial UI
  setStatus("DISCONNECTED", "bad");
  addLog("Ready.");
  addLog("Tip: If it feels slow, check Network tab for mqtt.min.js load time and WS handshake.");
  render();
})();
</script>
</body>
</html>
