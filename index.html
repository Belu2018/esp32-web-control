<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 Switches</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 28px; max-width: 520px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 16px; margin: 12px 0; }
    .row { display:flex; justify-content:space-between; align-items:center; gap:16px; }
    .muted { color:#555; font-size:0.92em; }
    .status { margin: 8px 0 18px; }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:8px; background:#ef4444; }
    .dot.ok { background:#22c55e; }
    button { padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; min-width: 110px; }
    .on { background:#0ea5e9; color:white; }
    .off { background:#e5e7eb; color:#111; }
    input { width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; }
    .grid { display:grid; gap:10px; }
    code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h2>ESP32 Web Control (GPIO26 & GPIO27)</h2>

  <div class="status muted">
    <span id="dot" class="dot"></span>
    <span id="conn">Disconnected</span>
  </div>

  <div class="card">
    <div class="grid">
      <div><b>HiveMQ Host</b> <span class="muted">(your cluster URL)</span></div>
      <input id="host" placeholder="xxxx.s1.eu.hivemq.cloud" />

      <div><b>WebSocket Port</b> <span class="muted">(HiveMQ shows 8884)</span></div>
      <input id="port" value="8884" />

      <div><b>Username</b> <span class="muted">(Access Management → MQTT Credentials)</span></div>
      <input id="user" placeholder="your-mqtt-username" />

      <div><b>Password</b> <span class="muted">(Access Management → MQTT Credentials)</span></div>
      <input id="pass" type="password" placeholder="your-mqtt-password" />

      <button onclick="connect()">Connect</button>

      <div class="muted">
        WSS URL:
        <code id="wsurl">-</code>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <b>Switch 1</b><br><span class="muted">GPIO 26</span>
      </div>
      <button id="b26" class="off" onclick="toggle26()">OFF</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <b>Switch 2</b><br><span class="muted">GPIO 27</span>
      </div>
      <button id="b27" class="off" onclick="toggle27()">OFF</button>
    </div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/script>
  <script>
    // Topics
    const t26Set   = "home/esp32/gpio26/set";
    const t27Set   = "home/esp32/gpio27/set";
    const t26State = "home/esp32/gpio26/state";
    const t27State = "home/esp32/gpio27/state";

    let client = null;
    let s26 = "OFF", s27 = "OFF";

    const dot  = document.getElementById("dot");
    const conn = document.getElementById("conn");
    const wsurl = document.getElementById("wsurl");
    const b26 = document.getElementById("b26");
    const b27 = document.getElementById("b27");

    function setButton(btn, state) {
      state = (state || "").toUpperCase();
      if (state === "ON") {
        btn.textContent = "ON";
        btn.className = "on";
      } else {
        btn.textContent = "OFF";
        btn.className = "off";
      }
    }

    function connect() {
      const host = document.getElementById("host").value.trim();
      const port = document.getElementById("port").value.trim() || "8884";
      const user = document.getElementById("user").value.trim();
      const pass = document.getElementById("pass").value;

      if (!host || !user || !pass) {
        alert("Please fill Host, Username, Password.");
        return;
      }

      const url = `wss://${host}:${port}/mqtt`; // matches HiveMQ TLS WebSocket URL
      wsurl.textContent = url;

      const clientId = "web-" + Math.random().toString(16).slice(2);

      client = mqtt.connect(url, {
        clientId,
        username: user,
        password: pass,
        clean: true,
        reconnectPeriod: 2000
      });

      client.on("connect", () => {
        dot.classList.add("ok");
        conn.textContent = "Connected";

        // Subscribe to retained state topics
        client.subscribe([t26State, t27State], (err) => {
          if (err) console.log("Subscribe error:", err);
        });
      });

      client.on("reconnect", () => {
        dot.classList.remove("ok");
        conn.textContent = "Reconnecting...";
      });

      client.on("close", () => {
        dot.classList.remove("ok");
        conn.textContent = "Disconnected";
      });

      client.on("error", (e) => console.log("MQTT error:", e));

      client.on("message", (topic, payload) => {
        const msg = payload.toString().trim().toUpperCase();
        if (topic === t26State) { s26 = msg; setButton(b26, s26); }
        if (topic === t27State) { s27 = msg; setButton(b27, s27); }
      });
    }

    function toggle26() {
      if (!client) return alert("Connect first");
      const next = (s26 === "ON") ? "OFF" : "ON";
      client.publish(t26Set, next, { qos: 0, retain: false });
      // UI updates when state message arrives (best practice)
    }

    function toggle27() {
      if (!client) return alert("Connect first");
      const next = (s27 === "ON") ? "OFF" : "ON";
      client.publish(t27Set, next, { qos: 0, retain: false });
    }
  </script>
</body>
</html>
